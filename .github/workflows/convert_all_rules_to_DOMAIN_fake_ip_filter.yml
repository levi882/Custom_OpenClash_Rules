name: Convert rules to DOMAIN fake_ip_filter

on:
  workflow_call:
    inputs:
      branch:
        required: false
        type: string
        default: ''
  push:
    branches: [ main ]
    paths:
      - "rule/**.yaml"
      - "rule/**.list"
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: ${{ inputs.branch != '' && inputs.branch || github.ref_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Convert all rules to DOMAIN fake_ip_filter
        run: |
          python <<'PYCODE'
          import os, re, glob

          def convert_line(line: str):
              """Â∞Ü Clash classical / list ËßÑÂàôË°åËΩ¨Êç¢‰∏∫ domain Ê®°Âºè"""
              line = line.strip()
              if not line or line.startswith("#"):
                  return None

              # ÂøΩÁï•ÈùûÂüüÂêçËßÑÂàô
              if any(x in line for x in [
                  "IP-CIDR", "SRC-IP-CIDR", "DST-PORT", "SRC-PORT", "GEOIP", "PROCESS-NAME"
              ]):
                  return None

              # ÂéªÈô§ YAML Êàñ list ÂâçÁºÄÁ¨¶Âè∑
              line = line.lstrip("-").strip()

              # Â§ÑÁêÜ classical ËßÑÂàôËØ≠Ê≥ï
              if "," in line:
                  parts = line.split(",", 1)
                  rule = parts[0].strip()
                  value = parts[1].strip()
                  if rule == "DOMAIN-SUFFIX":
                      return f".{value}"
                  elif rule == "DOMAIN":
                      return value
                  elif rule == "DOMAIN-KEYWORD":
                      return f"*{value}*"
                  else:
                      return None

              # Â§ÑÁêÜÁ∫ØÂüüÂêçÊ®°Âºè (.list Êñá‰ª∂)
              if re.match(r"^[\*\.\w\-]+(\.[a-zA-Z]{2,})$", line):
                  return line

              return None


          os.makedirs("rule_converted", exist_ok=True)
          files = glob.glob("rule/**/*.yaml", recursive=True) + glob.glob("rule/**/*.list", recursive=True)

          total = 0
          for path in files:
              with open(path, "r", encoding="utf-8") as f:
                  lines = f.readlines()

              converted = [convert_line(l) for l in lines]
              converted = [x for x in converted if x]

              if not converted:
                  print(f"‚ö†Ô∏è Ë∑≥ËøáÔºàÊó†ÊúâÊïàÂüüÂêçÔºâ: {path}")
                  continue

              output = "payload:\n" + "\n".join([f"  - {x}" for x in converted]) + "\n"

              new_path = os.path.splitext(path)[0] + "_fake_ip_filter.yaml"
              new_path = new_path.replace("rule/", "rule_converted/")
              os.makedirs(os.path.dirname(new_path), exist_ok=True)

              with open(new_path, "w", encoding="utf-8") as f:
                  f.write(output)

              total += 1
              print(f"‚úÖ Â∑≤ËΩ¨Êç¢: {path} -> {new_path}")

          print(f"\nüéâ ÂÖ±ÁîüÊàê {total} ‰∏™ fake_ip_filter Êñá‰ª∂")
          PYCODE

      - name: Commit and push converted results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add rule_converted
          git commit -m "Auto convert to DOMAIN fake_ip_filter" || echo "No changes"
          git push
